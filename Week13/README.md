## 学习笔记

## 微服务架构

- 微服务定义
  ```
    围绕业务功能构建的，服务关注单一业务，服务间采用轻量级的通信机制，可以全自动独立部署，可以使用不同的编程语言和数据存储技术。
  ```
- 微服务架构

#### 优点
 - 原子服务，独立进程，隔离不俗，去中心化服务治理

#### 缺点 
 - 服务之间的依赖关系复杂
 - 微服务本身是分布式系统，需要使用 RPC 或者 消息进行通信，此外，必须要写代码来处理消息传递中速度过慢或者服务不可用等局部失效问题
 - 分布式事务问题，因为现在每个微服务之间都会有一个独立的数据库，事务在单体应用中很好处理，但是在跨服务时会变得很麻烦
 - 测试麻烦，对于基础设施的要求高

#### 构建 
 - 多个微服务组合(compose)完成了一个完整的用户场景(usecase)

#### 架构
 - 移动端 -> API Gateway -> BFF -> 微服务

#### 如何拆分
 ```
  在对业务领域不是特别熟悉的时候，按照部门职能进行划分，例如账号、财务等
  注意划分的时候要闭环，不要相同的功能散落到几个部门当中
  在系统稳定之后，积累了相关的业务经验和微服务开发经验之后，再考虑使用 DDD 限界上下文 进行划分
  如果可以闭环的解决一个用户场景，那么它应该是一个微服务
  还可以根据访问频率进行区分划分，将用户高频访问的部分划分为一个服务
 ```

## API设计
 
### 目录结构
- /cmd 采用 /cmd/[appname]/main.go 的形式进行组织
- /internal internal 目录下的包，不允许被其他项目中进行导入
- pkg 外部应用程序可以使用的库代码(例如 /pkg/mypubliclib)
- kit 为不同的微服务建立一个统一的kit工具包项目(基础库/框架) 和 app 项目,
      统一、标准库方式布局、高度抽象、支持插件
- api API 协议定义目录，xxapi.proto protobuf 文件，以及生成的 go 文件。
  通常把 api 文档直接在 proto 文件中描述

### 微服务中的app服务类型分为4类
    interface,service,job,admin
1. interface: 对外的 BFF 服务，接受来自用户的请求， 比如暴露了 HTTP/gRPC 接口
2. service: 对内的微服务，仅接受来自内部其他服务或 者网关的请求，比如暴露了gRPC 接口只对内服务
3. admin：区别于 service，更多是面向运营测的服务， 通常数据权限更高，隔离带来更好的代码级别安全 
4. job: 流式任务处理的服务，上游一般依赖 message broker
5. task: 定时任务，类似 cronjob，部署到 task 托管平 台中


## 系统框架设计
 - 不依赖具体每个节点，而是改为依赖中间件，比如Kafka、redis、canal+mysql binlog订阅；或者无状态的服务，比如gRpc负载均衡器、etcd注册与服务发现 
 
 - 单个服务设计原则
 1. 是否保证了完整的链路，包括错误传递、超时传递
 2. 各个层次的依赖是否是强依赖关系 
 3. 考虑系统配置和参数使用注入形式，实现控制反转
 